<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lina-XPANOL-presentacion</title>

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

<style>
:root{
  --highlight: #F6B511;
  --bg-dim: 0.55;
  --font: "Special Elite", monospace;
}

html,body{
  height:100%;
  margin:0;
}

body{
  font-family: var(--font);
  background:#000;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  box-sizing:border-box;
}

.app {
  width:100%;
  max-width:1000px;
  text-align:center;
}

.line-box {
  min-height:120px;
  margin:0 auto 18px;
  padding:18px;
  background:rgba(0,0,0,0.25);
  border-radius:10px;
  box-shadow:0 6px 24px rgba(0,0,0,0.5);
}

.line {
  font-size:26px; /* powiększona czcionka */
  line-height:1.45;
  margin:12px 0;
  text-shadow: 0 2px 6px rgba(0,0,0,0.8);
}

.word { transition: color 0.12s ease; }
.word.highlight { color: var(--highlight); font-weight:700; }

.controls {
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  margin-top:6px;
}

.btn {
  background:var(--highlight);
  color:#000;
  border:0;
  padding:10px 16px;
  border-radius:8px;
  font-family:var(--font);
  font-size:16px;
  cursor:pointer;
}

.btn:active { transform:translateY(1px); }

@media (max-width:600px){
  .line { font-size:20px; }
  .line-box { padding:14px; min-height:110px; }
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Karaoke">
    <div class="line-box" id="lineBox" aria-live="polite"></div>
    <div class="controls" role="toolbar">
      <button class="btn" id="playBtn">Play</button>
      <button class="btn" id="restartBtn">Restart</button>
    </div>
  </div>

  <audio id="audio" src="001_es.mp3" preload="auto"></audio>

<script>
const JSON_FILE = '001_es.json';

const audio = document.getElementById('audio');
const lineBox = document.getElementById('lineBox');
const playBtn = document.getElementById('playBtn');
const restartBtn = document.getElementById('restartBtn');

let lines = [];
let rafId = null;

async function loadJson(file){
  const resp = await fetch(file);
  if(!resp.ok) throw new Error('Nie można wczytać JSON.');
  const data = await resp.json();
  return normalizeData(data);
}

function normalizeData(data){
  return data.map(item => {
    const words = (item.words || []).map(w => ({
      text: w.text,
      start: Number(w.start),
      end: Number(w.end)
    }));
    return {
      text: item.line !== undefined ? item.line : words.map(w=>w.text).join(' '),
      start: Number(item.start || (words.length?words[0].start:0)),
      end: Number(item.end || (words.length?words[words.length-1].end:0)),
      words
    };
  });
}

function renderLines(){
  lineBox.innerHTML = '';
  lines.forEach((L, li)=>{
    const div = document.createElement('div');
    div.className='line';
    L.words.forEach((w, wi)=>{
      const span = document.createElement('span');
      span.className='word';
      span.id = `w_${li}_${wi}`;
      span.textContent = w.text + (wi<L.words.length-1?' ':'');
      div.appendChild(span);
    });
    lineBox.appendChild(div);
  });
}

function highlightLoop(){
  const t = audio.currentTime;
  lines.forEach((L, li)=>{
    L.words.forEach((w, wi)=>{
      const span = document.getElementById(`w_${li}_${wi}`);
      if(!span) return;
      if(t>=w.start && t<=w.end){
        span.classList.add('highlight');
      } else {
        span.classList.remove('highlight');
      }
    });
  });
  if(!audio.paused){
    rafId = requestAnimationFrame(highlightLoop);
  }
}

playBtn.addEventListener('click', async ()=>{
  try{
    await audio.play();
    playBtn.textContent = 'Pause';
    if(!rafId) rafId=requestAnimationFrame(highlightLoop);
  }catch(err){
    console.error('Nie udało się odtworzyć audio w Safari:', err);
  }
});

restartBtn.addEventListener('click', ()=>{
  audio.currentTime=0;
  renderLines();
  audio.play();
  playBtn.textContent='Pause';
  if(!rafId) rafId=requestAnimationFrame(highlightLoop);
});

(async function init(){
  try{
    lines = await loadJson(JSON_FILE);
    renderLines();
  }catch(e){
    lineBox.innerHTML='<div style="color:#ffb3b3">Błąd w JSON</div>';
    console.error(e);
  }
})();
</script>
</body>
</html>
