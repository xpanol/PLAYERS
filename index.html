<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MARKETING DIGITAL / DIGITAL MARKETING</title>

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Special Elite', monospace;
    background-color: black;
    color: white;
    max-width: 1000px;
    margin: 50px auto;
    padding: 20px;
    background-image: url('logo.png');
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
  }

  h1 {
    text-align: center;
    margin-bottom: 40px;
    color: #F8AC10;
    font-family: 'Special Elite', monospace;
  }

  .player {
    margin-bottom: 40px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: 'Special Elite', monospace;
  }

  .karaoke-line {
    white-space: nowrap;
    font-size: 28px;
    display: flex;
    align-items: center;
    gap: 16px;
    font-family: 'Special Elite', monospace;
    cursor: pointer;
  }

  .word {
    transition: color 0.2s;
    font-family: 'Special Elite', monospace;
  }

  .highlight-es { color: #F8AC10; }
  .highlight-z { color: #c63843; }
  .completed { color: #9b835a; }

  .audio-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }

  button {
    font-family: 'Special Elite', monospace;
    background: #F8AC10;
    border: 1px solid white;
    color: white;
    cursor: pointer;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-size: 22px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 15px;
    flex-shrink: 0;
  }

  .time, .progress { display: none; }

  #playAllButton {
    border-radius: 5px;
    width: auto;
    height: auto;
    padding: 10px 20px;
    font-size: 16px;
    margin: 0 auto 30px auto;
    display: block;
  }

  /* Modal fullscreen */
  #fullscreenModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    z-index: 99999;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 25px;
    color: white;
  }

  #fullscreenText {
    font-size: 34px;
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    text-align: center;
  }

  #fullscreenClose {
    position: absolute;
    top: 25px;
    right: 25px;
    background: #F8AC10;
    border: 1px solid white;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    font-size: 28px;
  }

  #fullscreenPlay {
    margin-top: 40px;
    width: 75px;
    height: 75px;
    font-size: 32px;
    border-radius: 50%;
    background: #F8AC10;
  }
</style>
</head>
<body>

<h1>MARKETING DIGITAL / DIGITAL MARKETING</h1>

<button id="playAllButton">▶ Reproducir todo / Play All</button>
<div id="players"></div>

<!-- Modal fullscreen -->
<div id="fullscreenModal">
  <button id="fullscreenClose">X</button>
  <div id="fullscreenText"></div>
  <button id="fullscreenPlay">▶</button>
</div>

<script>
const playerControls = [];
let isPlayingAll = false;
let currentTrackIndex = 0;

// Elementos modal
const modal = document.getElementById('fullscreenModal');
const modalText = document.getElementById('fullscreenText');
const modalPlayBtn = document.getElementById('fullscreenPlay');
const modalClose = document.getElementById('fullscreenClose');
let modalAudio = null;
let modalWords = [];
let modalRaf = null;

// Abrir modal
function openModal(words, audioFile, type) {
  modal.style.display = 'flex';

  modalText.innerHTML = '';
  modalWords = [];

  modalAudio = new Audio(audioFile);

  const totalDuration = modalAudio.duration || 0;

  words.forEach(original => {
    const span = document.createElement('span');
    span.textContent = original.textContent;
    span.dataset.start = original.dataset.start;
    span.dataset.end = original.dataset.end;
    span.dataset.type = type;
    span.className = 'word';
    modalText.appendChild(span);
    modalWords.push(span);
  });

  function loop() {
    const t = modalAudio.currentTime;
    modalWords.forEach(span => {
      span.classList.remove('highlight-es', 'highlight-z');
      const s = parseFloat(span.dataset.start);
      const e = parseFloat(span.dataset.end);
      if(t >= s && t <= e){
        if(span.dataset.type === 'z') span.classList.add('highlight-z');
        else span.classList.add('highlight-es');
      }
    });

    if(modalAudio.paused) return;
    modalRaf = requestAnimationFrame(loop);
  }

  modalPlayBtn.onclick = () => {
    if(modalAudio.paused){
      modalAudio.currentTime = 0;
      modalAudio.play();
      modalPlayBtn.textContent = '❚❚';
      modalRaf = requestAnimationFrame(loop);
    } else {
      modalAudio.pause();
      modalPlayBtn.textContent = '▶';
      if(modalRaf){ cancelAnimationFrame(modalRaf); modalRaf = null; }
    }
  };
}

// Cerrar modal
modalClose.onclick = () => {
  modal.style.display = 'none';
  if(modalAudio){
    modalAudio.pause();
    modalAudio = null;
  }
  if(modalRaf){ cancelAnimationFrame(modalRaf); modalRaf = null; }
};

// Función cargar karaoke
async function loadKaraoke(audioFile, jsonFile, container, type) {
  try {
    const res = await fetch(jsonFile);
    if (!res.ok) throw new Error("No encontrado");
    const data = await res.json();

    const playerDiv = document.createElement('div');
    playerDiv.className = 'player';

    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'audio-container';

    const playBtn = document.createElement('button');
    playBtn.textContent = '▶';
    controlsDiv.appendChild(playBtn);

    const karaokeDiv = document.createElement('div');
    karaokeDiv.className = 'karaoke-line';

    const wordsArray = [];

    data.forEach((item) => {
      const words = item.text.split(' ');
      const start = item.start.split(':').reduce((a, b) => 60 * a + +b, 0);
      const end = item.end.split(':').reduce((a, b) => 60 * a + +b, 0);
      const duration = end - start;
      const wordDuration = duration / words.length;

      words.forEach((word, j) => {
        const span = document.createElement('span');
        span.textContent = word;
        span.dataset.start = (start + j * wordDuration).toFixed(2);
        span.dataset.end = (start + (j + 1) * wordDuration).toFixed(2);
        span.dataset.type = type;
        span.className = 'word';
        karaokeDiv.appendChild(span);
        wordsArray.push(span);
      });
    });

    playerDiv.appendChild(controlsDiv);
    playerDiv.appendChild(karaokeDiv);
    container.appendChild(playerDiv);

    const audio = document.createElement('audio');
    audio.src = audioFile;

    let rafId = null;
    let completed = false;

    function highlightLoop() {
      const t = audio.currentTime;
      wordsArray.forEach(span => {
        span.classList.remove('highlight-es', 'highlight-z');
        const s = parseFloat(span.dataset.start);
        const e = parseFloat(span.dataset.end);
        if(t >= s && t <= e){
          if(span.dataset.type === 'z') span.classList.add('highlight-z');
          else span.classList.add('highlight-es');
        }
      });

      if(t >= audio.duration){
        completed = true;
        wordsArray.forEach(span => span.classList.remove('highlight-es', 'highlight-z'));
        wordsArray.forEach(span => span.classList.add('completed'));
        playBtn.textContent = '▶';
        cancelAnimationFrame(rafId);
        rafId = null;
      } else if(!audio.paused) {
        rafId = requestAnimationFrame(highlightLoop);
      }
    }

    karaokeDiv.addEventListener('click', () => {
      if(isPlayingAll) stopAllPlayback();
      audio.pause();
      openModal(wordsArray, audioFile, type);
    });

    playBtn.addEventListener('click', () => {
      if(completed){
        wordsArray.forEach(span => span.classList.remove('completed', 'highlight-es', 'highlight-z'));
        audio.currentTime = 0;
        completed = false;
      }
      if(audio.paused){
        if(isPlayingAll) stopAllPlayback();
        audio.play();
        playBtn.textContent = '❚❚';
        if(!rafId) rafId = requestAnimationFrame(highlightLoop);
      } else {
        audio.pause();
        playBtn.textContent = '▶';
        if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
      }
    });

    audio.addEventListener('ended', () => {
      completed = true;
      wordsArray.forEach(span => span.classList.remove('highlight-es', 'highlight-z'));
      wordsArray.forEach(span => span.classList.add('completed'));
      playBtn.textContent = '▶';
      if(rafId){ cancelAnimationFrame(rafId); rafId = null; }

      if (isPlayingAll) {
        currentTrackIndex++;
        playNextTrack();
      }
    });

    playerControls.push({
      playBtn,
      audio,
      wordsArray,
      highlightLoop
    });

  } catch (err) {
    console.error(err);
  }
}

const playersContainer = document.getElementById('players');

const order = [];
for (let i = 1; i <= 30; i++) {
  const num = i.toString().padStart(3,'0');
  order.push({
    audio: `https://raw.githubusercontent.com/xpanol/PLAYERS/main/${num}_es.mp3`,
    json:  `https://raw.githubusercontent.com/xpanol/PLAYERS/main/${num}_es.json`,
    type: 'es'
  });
  order.push({
    audio: `https://raw.githubusercontent.com/xpanol/PLAYERS/main/Z${num}_en.mp3`,
    json:  `https://raw.githubusercontent.com/xpanol/PLAYERS/main/Z${num}_en.json`,
    type: 'z'
  });
}

async function loadAllSequentially() {
  for (const item of order) {
    await loadKaraoke(item.audio, item.json, playersContainer, item.type);
  }
}

function resetAllPlayers() {
  playerControls.forEach(c => {
    c.audio.pause();
    c.audio.currentTime = 0;
    c.playBtn.textContent = '▶';
    c.wordsArray.forEach(span => span.classList.remove('completed', 'highlight-es', 'highlight-z'));
  });
}

function playNextTrack() {
  const btn = document.getElementById('playAllButton');
  if (currentTrackIndex < playerControls.length && isPlayingAll) {
    const current = playerControls[currentTrackIndex];
    current.wordsArray.forEach(s => s.classList.remove('completed', 'highlight-es', 'highlight-z'));
    current.audio.currentTime = 0;
    current.audio.play().catch(() => {
      currentTrackIndex++;
      playNextTrack();
    });
    current.playBtn.textContent = '❚❚';
    current.rafId = requestAnimationFrame(current.highlightLoop);
  } else {
    stopAllPlayback();
    btn.textContent = '✅ Todo reproducido / All played';
    setTimeout(() => {
      btn.textContent = '▶ Reproducir todo / Play All';
    }, 3000);
  }
}

function stopAllPlayback() {
  isPlayingAll = false;
  document.getElementById('playAllButton').textContent = '▶ Reproducir todo / Play All';
  resetAllPlayers();
}

document.getElementById('playAllButton').addEventListener('click', () => {
  if (isPlayingAll) {
    stopAllPlayback();
  } else {
    isPlayingAll = true;
    currentTrackIndex = 0;
    resetAllPlayers();
    document.getElementById('playAllButton').textContent = '❚❚ Detener reproducción / Stop playback';
    playNextTrack();
  }
});

loadAllSequentially();
</script>

</body>
</html>
