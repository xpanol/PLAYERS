<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MARKETING DIGITAL / DIGITAL MARKETING</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Special Elite', monospace;
    background-color: black;
    color: white;
    max-width: 1000px;
    margin:50px auto;
    padding: 20px;
  }

  h1 {
    text-align: center;
    font-family: 'Special Elite', monospace;
    margin-bottom: 40px;
    color: #F6B511;
  }

  .player {
    margin-bottom: 40px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .karaoke-line {
    white-space: nowrap;
  }

  .word {
    font-size: 28px;
    padding-right: 8px;
    transition: color 0.2s;
  }

  .highlight {
    color: #F6B511;
    font-weight: 700;
  }

  .audio-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  button {
    font-family: 'Special Elite', monospace;
    background: #F6B511;
    border: 1px solid white;
    color: white;
    cursor: pointer;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-size: 22px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
    margin-bottom: 5px;
  }

  .time, .progress {
    display: none;
  }
</style>
</head>
<body>

<h1>MARKETING DIGITAL / DIGITAL MARKETING</h1>

<div id="players"></div>

<script>
async function loadKaraoke(audioFile, jsonFile, container) {
  try {
    const res = await fetch(jsonFile);
    if (!res.ok) throw new Error(`No se encontró ${jsonFile}`);
    const data = await res.json();

    const playerDiv = document.createElement('div');
    playerDiv.className = 'player';

    const audio = document.createElement('audio');
    audio.src = audioFile;

    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'audio-container';

    const playBtn = document.createElement('button');
    playBtn.textContent = '▶';
    controlsDiv.appendChild(playBtn);

    const karaokeDiv = document.createElement('div');
    karaokeDiv.className = 'karaoke-line';

    const wordsArray = [];

    data.forEach((item, i) => {
      const words = item.text.split(' ');
      const start = parseFloat(item.start.split(':').reduce((acc, time) => 60 * acc + +time));
      const end = parseFloat(item.end.split(':').reduce((acc, time) => 60 * acc + +time));
      const duration = end - start;
      const wordDuration = duration / words.length;

      const spanArray = [];

      words.forEach((word, j) => {
        const span = document.createElement('span');
        span.textContent = word;
        span.dataset.start = (start + j * wordDuration).toFixed(2);
        span.dataset.end = (start + (j + 1) * wordDuration).toFixed(2);
        span.id = `${audioFile}-word-${i}-${j}`;
        span.className = 'word';
        karaokeDiv.appendChild(span);
        spanArray.push(span);
      });

      wordsArray.push({spanArray, completed: false});
    });

    playerDiv.appendChild(controlsDiv);   
    playerDiv.appendChild(karaokeDiv);    
    container.appendChild(playerDiv);

    let rafId = null;
    let playing = false;

    function highlightLoop() {
      const t = audio.currentTime;
      wordsArray.forEach(obj => {
        obj.spanArray.forEach(span => {
          const start = parseFloat(span.dataset.start);
          const end = parseFloat(span.dataset.end);
          if(t >= start && t <= end){
            span.classList.add('highlight');
          } else {
            span.classList.remove('highlight');
          }
        });
      });
      if(!audio.paused) rafId = requestAnimationFrame(highlightLoop);
    }

    function resetKaraoke() {
      wordsArray.forEach(obj => {
        obj.spanArray.forEach(span => {
          span.style.color = '#fff';
          span.classList.remove('highlight');
        });
        obj.completed = false;
      });
      playBtn.style.backgroundColor = '#F6B511';
      playing = false;
    }

    playBtn.addEventListener('click', () => {
      if(!playing){
        if(audio.paused){
          audio.play();
        }
        playBtn.textContent = '❚❚';
        playing = true;
        rafId = requestAnimationFrame(highlightLoop);
      } else {
        audio.pause();
        playBtn.textContent = '▶';
        playing = false;
        if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
      }
    });

    audio.addEventListener('ended', () => {
      playBtn.textContent = '▶';
      playBtn.style.backgroundColor = '#9b835a';
      wordsArray.forEach(obj => {
        obj.completed = true;
        obj.spanArray.forEach(span => {
          span.style.color = '#9b835a';
          span.classList.remove('highlight');
        });
      });
      playing = false;
      if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
    });

    audio.addEventListener('play', () => {
      if(wordsArray.some(obj => obj.completed)){
        resetKaraoke();
        audio.currentTime = 0;
      }
    });

  } catch (err) {
    console.error('Error al cargar karaoke:', err);
  }
}

const playersContainer = document.getElementById('players');
const files = Array.from({ length: 30 }, (_, i) => i + 1);

files.forEach(i => {
  const num = i.toString().padStart(3, '0');
  const audioFile = `https://raw.githubusercontent.com/xpanol/PLAYERS/main/${num}_es.mp3`;
  const jsonFile = `https://raw.githubusercontent.com/xpanol/PLAYERS/main/${num}_es.json`;
  loadKaraoke(audioFile, jsonFile, playersContainer);
});
</script>

</body>
</html>
